#!/usr/bin/env bash

cd "$(dirname "$0")/../"

BUMP=${1:-minor}
VERSION="$(npx -c 'echo "$npm_package_version"')"
VERSION_BUMP="$(npx semver -i $BUMP $VERSION)"

rm -rf dist
tsc -b

ESMS="$(ls -d \
  dist/esm/index.js \
  dist/esm/client.js \
  dist/esm/components/*.js \
)"

for ESM in $ESMS; do
  BASE=${ESM##*/}
  BASE=${BASE%.*}
  MJS=dist/mjs/$BASE-$VERSION_BUMP.mjs
  npx rollup $ESM --context this --file $MJS -f esm --sourcemap
done

# npx rollup ./clouds/cloudflare.js \
#   -f cjs -c \
#   --context this \
#   --file dist/clouds/cloudflare.js
